doctype html
html
    head
    meta(charset='utf-8')
    title Line chart
    link(rel='stylesheet', type='text/css', href='/css/dc.css')
    style.
        body, html {
        height: 100%;
        margin: 10;
        padding: 0;
        }
        div {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        }
        h2 {
        font-family: helvetica;
        font-weight: 100;
        color: grey;
        font-size: 20pt;
        }
        div#chart svg g g.axis g.tick text {
        font-size: 11pt;
        }


    meta(http-equiv='Content-type', content='text/html; charset=utf-8')
    meta(name='viewport', content='width=device-width,initial-scale=1')
    title Load PMS
    link(rel='shortcut icon', type='image/png', href='/media/images/favicon.png')
    //link(rel='alternate', type='application/rss+xml', title='RSS 2.0', href='http://www.datatables.net/rss.xml')
    link(href='/css/bootstrap.css', rel='stylesheet')
    //link(rel='stylesheet', type='text/css', href='https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css')//ok
    link(rel='stylesheet', type='text/css', href='/css/jquery.dataTables.min.css')
    script(type='text/javascript', language='javascript', src='/js/jquery-1.12.4.min.js')
    //script(type='text/javascript', language='javascript', src='//code.jquery.com/jquery-1.12.4.js')//ok
    //script(type='text/javascript', language='javascript', src='https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js')//OK
    script(type='text/javascript', language='javascript', src='/js/jquery.dataTables.js')
    //script(type='text/javascript', language='javascript', src='/js/jquery.dataTables.min.js')
    //script(type="text/javascript", src="http://d3js.org/d3.v3.min.js") //ok
    script(type="text/javascript", src="/js/d3.v4.min.js") 
    
    //- //DO FOR BUTTON Download
    //- script(type="text/javascript", src="/js/dataTables.buttons.min.js") 
    //- script(type="text/javascript", src="/js/jszip.min.js") 
    //- script(type="text/javascript", src="/js/pdfmake.min.js") 
    //- script(type="text/javascript", src="/js/vfs_fonts.js") 
    //- script(type="text/javascript", src="/js/buttons.html5.min.js") 
    //DO RESIZE W
    script(type="text/javascript", src="/js/dataTables.pageResize.min.js") 
    script(type='text/javascript', language='javascript', src='/js/url2id.js')
    script(type='text/javascript', src='/js/d3.js')
    script(type='text/javascript', src='/js/crossfilter.js')
    script(type='text/javascript', src='/js/dc.js')
      
      
      
  body.wide.comments.example
    h2 Total Output
    #chart
    #range-chart

    table#testd3.display(cellspacing='0', width='100%')
    //- script.init(type='text/javascript').
    script.

      $(document).ready(function() {

          //alert(`now show  ${linename}` )
          //alert(`now show  ${qty}` )
          refresh();

      } );
        // refresh each n min
        var ntime = 0.01;
        var time = new Date().getTime();
        $(document.body).bind("mousemove keypress", function (e) {
                 time = new Date().getTime();
        });
        function f5() {
            if (new Date().getTime() - time >= 60000){
                window.location.reload(true);
                console.log('loaded');
            }
                
            else
            setTimeout(f5, 10000*ntime);
        }
        setTimeout(f5, 10000*ntime);

      var qty = #{q10};
      var linename = `#{linename}`;
      
      function refresh() {
      $('#testd3').empty();
                buildHtmlTableD3(`/sql/vnmsrv601/
            exec Finalassy.dbo.sp001_RealtimeReport ${linename}
        
            `,'#testd3');
      load();
     
      }
         
        function load() { fetchJSONFile(`/sql/vnmsrv601/
            exec Finalassy.dbo.sp001_RealtimeReport ${linename}
                   `, function (pmsdb){
                       
                    console.log('temp ',pmsdb);
                    alert(JSON.stringify(pmsdb));  
                    
                    pmsdb.forEach(function(d){
                        var tempDate = new Date(d.RefStartDate);
                        d.RefStartDate = tempDate;
                    })
                    var facts = crossfilter(pmsdb);
                    // var typeDimension = facts.dimension(function(d){ return d.type; });
                    // var typeGroup = typeDimension.group().reduceSum(function(d){ return d.total; });
                    //
                    // var totalDimension = facts.dimension(function(d){ return d.total; });
                    // var totalGroup = totalDimension.group(function(d){ return Math.floor(d/100)*100; });

                    var dateDimension = facts.dimension(function(d){ return d.RefStartDate; });
                    var volGroup = dateDimension.group();

                    var dateGroup = dateDimension.group().reduceSum(function(d){ return d.AssemblyQty; });
                    var dateGroupTip = dateDimension.group().reduceSum(function(d){ return d.AssemblyQty+10; });

                    var minDate = dateDimension.bottom(1)[0].RefStartDate;
                    var maxDate = dateDimension.top(1)[0].RefEndDate;

                    var volChart = dc.barChart("#range-chart")
                        .height(70)
                        .width(1360)
                        .margins({top:10,bottom:30,right:10,left:70})
                        .dimension(dateDimension)
                        .group(volGroup)
                        .x(d3.time.scale().domain([minDate,maxDate]));

                        volChart.yAxis().ticks(0).outerTickSize(0);
                        volChart.xAxis().ticks(4);

                    var lineChart = dc.lineChart("#chart")
                        .width(1360)
                        .height(200)
                        .brushOn(false)
                        .rangeChart(volChart)
                        .margins({top:10,bottom:30,right:10,left:70})
                        .dimension(dateDimension)
                        .group(dateGroup,"Actual Out")
                        .stack(dateGroupTip,"Target")
                        .yAxisLabel("Qty")
                        .renderHorizontalGridLines(true)
                        .renderArea(true)
                        .legend(dc.legend().x(1200).y(5).itemHeight(12).gap(5))
                        .x(d3.time.scale().domain([minDate,maxDate]));
                        // .centerBar(true)
                        //.xUnits(dc.units.fp.precision(100));
                        // .barPadding(0.2)
                        // .outerPadding(0)
                        lineChart.yAxis().ticks(5);
                        lineChart.xAxis().ticks(4);


                    dc.renderAll();

                    // console.log(data);
                    console.log(dateDimension.top(1)[0].RefStartDate);
                    console.log(dateDimension.bottom(1)[0].RefStartDate);

                   }

            );
        }

        

        
      
     

     
    
     
  
   
