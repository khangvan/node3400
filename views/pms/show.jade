doctype html
html
    head
    meta(charset='utf-8')
    title Line chart
    link(rel='stylesheet', type='text/css', href='/css/dc.css')
    style.
        body, html {
        height: 100%;
        margin: 10;
        padding: 0;
        }
        div {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        }
        h2 {
        font-family: helvetica;
        font-weight: 100;
        color: grey;
        font-size: 20pt;
        }
        div#chart svg g g.axis g.tick text {
        font-size: 11pt;
        }


    meta(http-equiv='Content-type', content='text/html; charset=utf-8')
    meta(name='viewport', content='width=device-width,initial-scale=1')
    title Load PMS
    link(rel='shortcut icon', type='image/png', href='/media/images/favicon.png')
    //link(rel='alternate', type='application/rss+xml', title='RSS 2.0', href='http://www.datatables.net/rss.xml')
    link(href='/css/bootstrap.css', rel='stylesheet')
    //link(rel='stylesheet', type='text/css', href='https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css')//ok
    link(rel='stylesheet', type='text/css', href='/css/jquery.dataTables.min.css')
    script(type='text/javascript', language='javascript', src='/js/jquery-1.12.4.min.js')
    //script(type='text/javascript', language='javascript', src='//code.jquery.com/jquery-1.12.4.js')//ok
    //script(type='text/javascript', language='javascript', src='https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js')//OK
    script(type='text/javascript', language='javascript', src='/js/jquery.dataTables.js')
    //script(type='text/javascript', language='javascript', src='/js/jquery.dataTables.min.js')
    //script(type="text/javascript", src="http://d3js.org/d3.v3.min.js") //ok
    script(type="text/javascript", src="/js/d3.v4.min.js") 
    
    //- //DO FOR BUTTON Download
    //- script(type="text/javascript", src="/js/dataTables.buttons.min.js") 
    //- script(type="text/javascript", src="/js/jszip.min.js") 
    //- script(type="text/javascript", src="/js/pdfmake.min.js") 
    //- script(type="text/javascript", src="/js/vfs_fonts.js") 
    //- script(type="text/javascript", src="/js/buttons.html5.min.js") 
    //DO RESIZE W
    script(type="text/javascript", src="/js/dataTables.pageResize.min.js") 
    script(type='text/javascript', language='javascript', src='/js/url2id.js')
    script(type='text/javascript', src='/js/d3.js')
    script(type='text/javascript', src='/js/crossfilter.js')
    script(type='text/javascript', src='/js/dc.js')
      
      
      
  body.wide.comments.example
    h2 Line chart: total payment plus tip
    #chart

    table#testd3.display(cellspacing='0', width='100%')
    //- script.init(type='text/javascript').
    script.

      $(document).ready(function() {

          //alert(`now show  ${linename}` )
          //alert(`now show  ${qty}` )
          refresh();

      } );
        // refresh each n min
        var ntime = 0.01;
        var time = new Date().getTime();
        $(document.body).bind("mousemove keypress", function (e) {
                 time = new Date().getTime();
        });
        function f5() {
            if (new Date().getTime() - time >= 60000){
                window.location.reload(true);
                console.log('loaded');
            }
                
            else
            setTimeout(f5, 10000*ntime);
        }
        setTimeout(f5, 10000*ntime);

      var qty = #{q10};
      var linename = `#{linename}`;
      
      function refresh() {
      $('#testd3').empty();
                buildHtmlTableD3(`/sql/vnmsrv601/
            exec Finalassy.dbo.sp001_RealtimeReport ${linename}
        
            `,'#testd3');
      
     
      }
      function print_filter(filter) {
        var f=eval(filter);
        if (typeof(f.length) != "undefined") {}else{}
        if (typeof(f.top) != "undefined") {f=f.top(Infinity);}else{}
        if (typeof(f.dimension) != "undefined") {f=f.dimension(function(d) { return "";}).top(Infinity);}else{}
        console.log(filter+"("+f.length+") = "+JSON.stringify(f).replace("[","[\\n\t").replace(/}\,/g,"},\n\t").replace("]","\n]"));
        }
        var data = [
        {date: "2011-11-14T16:17:54Z", quantity: 2, total: 190, tip: 100, type: "tab"},
        {date: "2011-11-14T16:20:19Z", quantity: 2, total: 190, tip: 100, type: "tab"},
        {date: "2011-11-14T16:28:54Z", quantity: 1, total: 300, tip: 200, type: "visa"},
        {date: "2011-11-14T16:30:43Z", quantity: 2, total: 90, tip: 0, type: "tab"},
        {date: "2011-11-14T16:48:46Z", quantity: 2, total: 90, tip: 0, type: "tab"},
        {date: "2011-11-14T16:53:41Z", quantity: 2, total: 90, tip: 0, type: "tab"},
        {date: "2011-11-14T16:54:06Z", quantity: 1, total: 100, tip: 0, type: "cash"},
        {date: "2011-11-14T16:58:03Z", quantity: 2, total: 90, tip: 0, type: "tab"},
        {date: "2011-11-14T17:07:21Z", quantity: 2, total: 90, tip: 0, type: "tab"},
        {date: "2011-11-14T17:22:59Z", quantity: 2, total: 90, tip: 0, type: "tab"},
        {date: "2011-11-14T17:25:45Z", quantity: 2, total: 200, tip: 0, type: "cash"},
        {date: "2011-11-14T17:29:52Z", quantity: 1, total: 200, tip: 100, type: "visa"}
        ];
        data.forEach(function(d){
        var tempDate = new Date(d.date);
        d.date = tempDate;
        })
        var facts = crossfilter(data);
        var typeDimension = facts.dimension(function(d){ return d.type; });
        var typeGroup = typeDimension.group().reduceSum(function(d){ return d.total; });
        var totalDimension = facts.dimension(function(d){ return d.total; });
        var totalGroup = totalDimension.group(function(d){ return Math.floor(d/100)*100; });
        var dateDimension = facts.dimension(function(d){ return d.date; });
        var dateGroup = dateDimension.group().reduceSum(function(d){ return d.total; });
        var dateGroupTip = dateDimension.group().reduceSum(function(d){ return d.tip; });
        var minDate = dateDimension.bottom(1)[0].date;
        var maxDate = dateDimension.top(1)[0].date;
        var lineChart = dc.lineChart("#chart")
        .width(1360)
        .height(200)
        .margins({top:10,bottom:30,right:10,left:70})
        .dimension(dateDimension)
        .group(dateGroup,"total spend")
        .stack(dateGroupTip,"tip")
        .yAxisLabel("Transaction spend")
        .renderHorizontalGridLines(true)
        .renderArea(true)
        .legend(dc.legend().x(1200).y(5).itemHeight(12).gap(5))
        .x(d3.time.scale().domain([minDate,maxDate]));
        // .centerBar(true)
        //.xUnits(dc.units.fp.precision(100));
        // .barPadding(0.2)
        // .outerPadding(0)
        lineChart.yAxis().ticks(5);
        lineChart.xAxis().ticks(4);
        dc.renderAll();
        // console.log(data);
        console.log(dateDimension.top(1)[0].date);
        //print_filter('dateDimension.bottom(3)');
      
     

     
    
     
  
   
